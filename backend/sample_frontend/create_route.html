<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create New Route</title>
    <script src="https://js.api.here.com/v3/3.1/mapsjs-core.js"></script>
    <script src="https://js.api.here.com/v3/3.1/mapsjs-service.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        body { font-family: Arial, sans-serif; text-align: center; }
        #map { height: 500px; width: 80%; margin: 10px auto; }
        .button-container { margin-top: 10px; }
        button { padding: 10px; margin: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <h2>Create a New Route</h2>
    <p>Select an origin and destination on the map.</p>
    <div id="map"></div>

    <div class="button-container">
        <button id="clear-map-btn" onclick="resetMap()">Clear Map</button>
        <button id="confirm-route-btn" onclick="confirmRoute()" style="display:none;">Confirm Route</button>
        <button onclick="window.location.href='menu.html'">Back to Menu</button>
    </div>

    <script>
        let map, origin, destination, polylineLayer, encodedPolyline, driverId;
        let markers = [];

        async function loadMap() {
            driverId = localStorage.getItem("driverId");
            if (!driverId) {
                alert("Error: No driver logged in.");
                window.location.href = "menu.html";
                return;
            }

            map = L.map('map').setView([1.3946, 103.8347], 14);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);

            map.on('click', async function (e) {
                const { lat, lng } = e.latlng;
                if (!origin) {
                    origin = [lat, lng];
                    addMarker(lat, lng, "Origin");
                } else if (!destination) {
                    destination = [lat, lng];
                    addMarker(lat, lng, "Destination");
                    await fetchRoute();
                }
            });
        }

        function addMarker(lat, lng, label) {
            const marker = L.marker([lat, lng]).addTo(map).bindPopup(label).openPopup();
            markers.push(marker);
        }

        async function fetchRoute() {
            if (!origin || !destination) {
                alert("Please select both origin and destination.");
                return;
            }

            try {
                const response = await fetch(`http://localhost:3000/api/get-route?origin=${origin}&destination=${destination}`);
                const data = await response.json();

                if (data.polyline) {
                    encodedPolyline = data.polyline;
                    drawRouteOnMap(encodedPolyline);
                    document.getElementById("confirm-route-btn").style.display = "block";
                } else {
                    alert("No route found!");
                }
            } catch (error) {
                console.error("Error fetching route:", error);
            }
        }

        function drawRouteOnMap(encodedPolyline) {
            if (polylineLayer) {
                map.removeLayer(polylineLayer);
            }

            const decoded = H.geo.LineString.fromFlexiblePolyline(encodedPolyline);
            const coords = decoded.getLatLngAltArray();
            const leafletCoords = [];

            for (let i = 0; i < coords.length; i += 3) {
                leafletCoords.push([coords[i], coords[i + 1]]);
            }

            polylineLayer = L.polyline(leafletCoords, { color: 'blue', weight: 5 }).addTo(map);
            map.fitBounds(L.latLngBounds(leafletCoords));
        }

        function resetMap() {
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
            origin = null;
            destination = null;

            if (polylineLayer) {
                map.removeLayer(polylineLayer);
                polylineLayer = null;
            }

            document.getElementById("confirm-route-btn").style.display = "none";
        }

        async function confirmRoute() {
            const response = await fetch(`http://localhost:3000/api/get-next-route-id?driver_id=${driverId}`);
            const data = await response.json();
            const routeId = data.next_route_id;

            if (!routeId) {
                alert("Error generating route ID.");
                return;
            }

            const newRoute = {
                route_id: routeId,
                polyline: encodedPolyline,
                origin: origin,
                destination: destination,
                journey_started: false
            };

            try {
                await fetch("http://localhost:3000/api/add-route", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ driver_id: driverId, route: newRoute })
                });

                alert("âœ… Route successfully created!");
                window.location.href = "menu.html";
            } catch (error) {
                console.error("Error saving route:", error);
                alert("Error saving route.");
            }
        }

        window.onload = loadMap;
    </script>
</body>
</html>
