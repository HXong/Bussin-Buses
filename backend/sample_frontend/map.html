<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Driver Map</title>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
</head>
<body>
    <h2>Driver Map - Route <span id="route-id">N/A</span></h2>
    <div id="notification-area"></div>

    <div id="map" style="height: 500px; width: 80%; margin: 10px auto;"></div>

    <div class="button-container">
        <button onclick="window.location.href='route_selection.html'">Back</button>
        <button id="start-journey-btn" onclick="startJourney()">Start Journey</button>
        <button id="stop-journey-btn" onclick="stopJourney()" style="display:none;">Stop Journey</button>
        <button id="reroute-btn" onclick="handleReroute()" style="display:none;">Reroute</button>
    </div>

    <script>
        let map;
        let routePolyline;
        let origin;
        let destination;
        let driverLocation;
        let refreshIntervalId;
        let driverMarker = null;

        function loadMap() {
            driverLocation = JSON.parse(localStorage.getItem("driverLocation"));
            map = L.map('map').setView(driverLocation, 14);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);

            fetchRoute();
        }

        async function fetchRoute() {
            const driverId = localStorage.getItem("driverId");
            const routeId = localStorage.getItem("selectedRoute");
            

            document.getElementById("route-id").innerText = routeId;
            const route = await fetch(`http://localhost:3000/api/scheduled-routes/${driverId}`);
            const routeData = await route.json();

            const selectedRoute = routeData.scheduled_route.find(route => route.route_id === routeId);
            origin = localStorage.setItem("origin", selectedRoute.origin);
            destination = localStorage.setItem("destination", selectedRoute.destination);
            console.log(`Found Selected Route: ${routeId}, Fetching Optimized Route...`);
            // const decodedPolyline = await fetch(`http://localhost:3000/api/decode-route?encodedPolyline=${selectedRoute.polyline}`);
            // const decodedRoute = await decodedPolyline.json();
        }

        function drawRouteOnMap(decodedPolyline) {
            try {
                const leafletCoords = [];
                decodedPolyline.forEach(coord => {
                    leafletCoords.push([coord[0], coord[1]]);
                });

                if (routePolyline) {
                    map.removeLayer(routePolyline);
                }

                routePolyline = L.polyline(leafletCoords, { color: 'blue', weight: 5 }).addTo(map);
                map.fitBounds(L.latLngBounds(leafletCoords));
            } catch (err) {
                console.error("Error decoding polyline:", err);
            }
        }

        async function checkNotifications() {
            const driverId = localStorage.getItem("driverId");
            if (!driverId) {
                console.warn("No driver logged in. Skipping notification check.");
                return;
            }

            try {
                const response = await fetch(`http://localhost:3000/api/get-notifications/${driverId}`);

                if (!response.ok) {
                    throw new Error("Failed to fetch notifications");
                }

                const data = await response.json();

                if (data.notifications.length > 0) {

                    const ignoredCongestions = JSON.parse(localStorage.getItem("ignoredCongestions")) || [];

                    const latestNotification = data.notifications.find(n => !ignoredCongestions.includes(n.cameraId));

                    if (latestNotification) {
                        showNotification(latestNotification.message, latestNotification.cameraId);
                    }
                }
            } catch (error) {
                console.error("Error fetching notifications:", error);
            }
        }

        function showNotification(message, cameraId) {
            const notificationArea = document.getElementById("notification-area");
    
            notificationArea.innerHTML = `
                <p>${message}</p>
                <button id="stay-route-btn">Stay on Route</button>
                <button id="reroute-btn">Reroute</button>
            `;
            
            document.getElementById("stay-route-btn").onclick = function () {
                ignoreReroute(cameraId);
            };

            document.getElementById("reroute-btn").onclick = function () {
                handleReroute();
            };

            notificationArea.style.display = "block";
        }

        function ignoreReroute(cameraId) {
            console.log(`Ignoring reroute for congestion at Camera ${cameraId}`);

            let ignoredCongestions = JSON.parse(localStorage.getItem("ignoredCongestions")) || [];
            if (!ignoredCongestions.includes(cameraId)) {
                ignoredCongestions.push(cameraId);
                localStorage.setItem("ignoredCongestions", JSON.stringify(ignoredCongestions));
            }

            document.getElementById("notification-area").style.display = "none";
        }

        async function handleReroute() {
            destination = localStorage.getItem("destination");

            try {
                const response = await fetch(`http://localhost:3000/api/get-route?origin=${driverLocation}&destination=${destination}`);
                const data = await response.json();
                if (data.decodedRoute) {
                    drawRouteOnMap(data.decodedRoute);
                    await updateDriverLocation(driverLocation, data.polyline);
                    showNotification("New optimized route applied!");
                    document.getElementById("reroute-btn").style.display = "none";
                }
            } catch (error) {
                console.error("Error fetching optimized route:", error);
            }
        }

        async function updateDriverLocation(location, polyline) {
            const driverId = localStorage.getItem("driverId");
            const routeId = localStorage.getItem("selectedRoute");

            if (!driverId) {
                console.error("Error: driverId is undefined. Login might have failed.");
                return;
            }

            try {
                const response = await fetch("http://localhost:3000/api/update-driver", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ driver_id: driverId, route_id: routeId, currentLocation: location, polyline })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error);
                }

                const data = await response.json();
                console.log("Driver location updated successfully:", data);
            } catch (error) {
                console.error("Error updating driver location:", error);
            }

            
            localStorage.setItem("driverLocation", JSON.stringify(location));
            localStorage.setItem("polyline", polyline);
        }

        function updateDriverLocationOnClick(e) {
            const { lat, lng } = e.latlng;

            console.log(`New driver location selected: ${lat}, ${lng}`);

            if (driverMarker) {
                map.removeLayer(driverMarker);
            }

            driverMarker = L.marker([lat, lng]).addTo(map).bindPopup("Driver Location").openPopup();

            driverLocation = [lat, lng];
            localStorage.setItem("driverLocation", JSON.stringify(driverLocation));

            updateDriverLocation(driverLocation);
        }

        
        async function startJourney() {
            const driverId = localStorage.getItem("driverId");
            const routeId = localStorage.getItem("selectedRoute");

            if (!driverId || !routeId) {
                console.error("Missing driver ID or route ID.");
                return;
            }

            console.log("Starting Journey for Driver:", driverId, "Route:", routeId);

            try {
                const response = await fetch("http://localhost:3000/api/start-journey", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ driver_id: driverId, route_id: routeId })
                });
                const data = await response.json();

                if (data.decodedRoute){
                    drawRouteOnMap(data.decodedRoute);
                    //store response.polyline in session
                } else {
                    console.log("failed to retrieve route");
                }

                refreshIntervalId = setInterval(checkNotifications, 10000);
                map.on("click", updateDriverLocationOnClick);

                document.getElementById("start-journey-btn").innerText = "Journey Started";
                document.getElementById("start-journey-btn").disabled = true;
                document.getElementById("stop-journey-btn").style.display = "block"; 

                localStorage.setItem("journeyStarted", "true");
            } catch (error) {
                console.error("Error starting journey:", error);
            }
        }

        async function stopJourney() {
            const driverId = localStorage.getItem("driverId");
            const routeId = localStorage.getItem("selectedRoute");

            if (!driverId || !routeId) {
                console.error("Missing driver ID or route ID.");
                return;
            }

            console.log("Stopping Journey for Driver:", driverId, "Route:", routeId);

            try {
                const response = await fetch("http://localhost:3000/api/stop-journey", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ driver_id: driverId, route_id: routeId })
                });

                if (!response.ok) throw new Error("Failed to stop journey");

                // Disable notifications
                clearInterval(refreshIntervalId);
                map.off("click", updateDriverLocationOnClick);

                // Reset UI
                document.getElementById("start-journey-btn").innerText = "Start Journey";
                document.getElementById("start-journey-btn").disabled = false;
                document.getElementById("stop-journey-btn").style.display = "none";

                localStorage.removeItem("journeyStarted");
                localStorage.removeItem("selectedRoute");

                window.location.href = "route_selection.html";
            } catch (error) {
                console.error("ðŸš¨ Error stopping journey:", error);
            }
        }

        window.onload = async function () {
            const driverId = localStorage.getItem("driverId");
            const selectedRoute = localStorage.getItem("selectedRoute");

            if (!driverId) {
                window.location.href = "/";
                return;
            }

            try {
                const response = await fetch(`http://localhost:3000/api/check-journey/${driverId}/${selectedRoute}`);
                const data = await response.json();

                if (data.journey_started) {
                    console.log("Resuming Journey...");
                    startJourney();
                }
            } catch (error) {
                console.error("Error checking journey status:", error);
            }
        };

        loadMap();
    </script>
</body>
</html>
